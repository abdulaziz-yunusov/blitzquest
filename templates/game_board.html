{% extends "base.html" %}
{% load static %}

{% block title %}Board â€“ Game {{ game.code }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/game_board.css' %}">
{% endblock %}

{% block content %}
<div class="board-page">

    <!-- Top bar -->
    <section class="board-header">
        <div class="board-header-left">
            <div class="game-avatar">{{ game.code|slice:":2" }}</div>
            <div>
                <h2 class="board-title">Game {{ game.code }}</h2>
                <div class="board-subtitle">
                    {{ game.get_mode_display }} mode â€¢ {{ game.players.count }}/{{ game.max_players }} players
                </div>
            </div>
        </div>
        <div class="board-header-right">
            <span class="badge badge-status badge-{{ game.status }}">
                {{ game.get_status_display }}
            </span>
            <a href="{% url 'game:game_detail' game.id %}" class="btn btn-secondary btn-sm">
                Back to lobby
            </a>
        </div>
    </section>

    <!-- Main layout: big board + right side panel -->
    <section class="board-layout">
      <aside class="board-inventory">

        <!-- Players status (separate from rankings) -->
        <div class="sidebar-section">
          <h3>Players status</h3>

          <div class="player-status-list" id="player-status-body">
            <!-- Filled by JS -->
          </div>
        </div>

        <!-- Inventory -->
        <div class="sidebar-section">
          <h3>Your inventory</h3>

          <div class="inventory-meta">
            <div>Shield: <strong id="inv-shield">0</strong></div>
            <div>Extra rolls: <strong id="inv-extra-rolls">0</strong></div>
          </div>

          <div id="inventory-cards" class="inventory-cards"></div>

          <div class="inventory-hint">
            You can use support cards any time.
          </div>
        </div>

      </aside>


        <!-- MAIN BOARD AREA -->
        <div class="board-main-wrap">
            <div class="board-main-header">
                <h3 class="section-title">
                    Board
                    {% if tiles %}
                        ({{ tiles|length }} tiles)
                    {% endif %}
                </h3>
                <div class="section-subtitle">
                    Tiles are generated randomly when the game starts.
                </div>
            </div>

            <!-- Board tiles.
                 Initial server render is simple; JS will replace this with
                 live state from /games/<id>/state/ -->
            <div id="board-tiles" class="board-tiles-ring">
                {% for tile in tiles %}
                    <div class="board-tile board-tile-{{ tile.tile_type|lower }}"
                         data-position="{{ tile.position }}">
                        <span class="board-tile-index">{{ tile.position|add:1 }}</span>
                        <span class="board-tile-symbol">
                            {% if tile.tile_type == "start" %}S
                            {% elif tile.tile_type == "question" %}?{# Blitz question #}
                            {% elif tile.tile_type == "trap" %}!{# Trap #}
                            {% elif tile.tile_type == "heal" %}+{# Heal #}
                            {% elif tile.tile_type == "bonus" %}B
                            {% elif tile.tile_type == "warp" %}W
                            {% elif tile.tile_type == "mass_warp" %}MW
                            {% elif tile.tile_type == "duel" %}D
                            {% elif tile.tile_type == "shop" %}${# Shop #}
                            {% elif tile.tile_type == "empty" %}&nbsp;
                            {% elif tile.tile_type == "finish" %}F
                            {% elif tile.tile_type == "gun" %}G
                            {% endif %}
                        </span>
                        <div class="tile-tokens"></div>
                    </div>
                {% endfor %}
            </div>

            <!-- Legend -->
            <div class="board-legend">
                <span class="legend-item">
                    <span class="legend-color board-tile-start"></span> Start
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-finish"></span> Finish
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-question"></span> Question
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-trap"></span> Trap
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-heal"></span> Heal
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-bonus"></span> Bonus
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-warp"></span> Warp
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-mass_warp"></span> Mass warp
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-duel"></span> Duel
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-gun"></span> Gun
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-shop"></span> Shop
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-empty"></span> Empty
                </span>
                <span class="legend-item">
                    <span class="legend-color board-tile-portal"></span> Portal
                </span>
            </div>
        </div>

        <!-- SIDEBAR: turn/dice, players, activity -->
        <aside class="board-sidebar">
            <!-- Turn & dice -->
            <div class="sidebar-section">
                <h3>Turn &amp; dice</h3>
                <div id="current-turn-label" class="current-turn-label">
                    Determining current player.
                </div>
                <div class="dice-display-wrapper">
                    <div id="dice-display" class="dice-display" data-has-value="">
                        <div class="bq-dice">
                        <ol class="bq-die-list even-roll" data-roll="1" id="bq-die-1" aria-label="Dice">
                            <li class="bq-die-item" data-side="1"><span class="bq-dot"></span></li>
                            <li class="bq-die-item" data-side="2"><span class="bq-dot"></span><span class="bq-dot"></span></li>
                            <li class="bq-die-item" data-side="3"><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span></li>
                            <li class="bq-die-item" data-side="4"><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span></li>
                            <li class="bq-die-item" data-side="5"><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span></li>
                            <li class="bq-die-item" data-side="6"><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span><span class="bq-dot"></span></li>
                        </ol>
                        </div>

                        <div id="dice-text" class="dice-text">
                        Roll the dice when it is your turn.
                        </div>
                    </div>
                    <button type="button" id="roll-button" class="btn btn-primary">
                        Roll dice
                    </button>
                </div>
            </div>

            <!-- Players -->
            <div class="sidebar-section">
                <h3>Player Ranks</h3>
                <div class="sidebar-player-count">
                    <span id="player-count">
                        {{ game.players.count }} / {{ game.max_players }}
                    </span>
                </div>
                <ul class="player-list" id="player-list">
                  {% for p in players %}
                    <li class="rank-row">
                      <div class="rank-left">
                        <div class="rank-badge">{{ forloop.counter }}</div>
                        <div class="rank-name">{{ p.user.username }}</div>
                      </div>
                    </li>
                  {% empty %}
                    <li>No players</li>
                  {% endfor %}
                </ul>

            </div>

            <!-- Activity log -->
            <div class="sidebar-section">
                <h3>Activity</h3>
                <div id="dice-log" class="dice-log"></div>
            </div>
        </aside>
    </section>
</div>
<div id="finishModal" class="bq-modal bq-hidden" aria-hidden="true">
  <div class="bq-modal-card" role="dialog" aria-modal="true" aria-labelledby="finishTitle">
    <div class="bq-modal-header">
      <h3 id="finishTitle" class="bq-modal-title">Congratulations!</h3>
      <button type="button" class="bq-modal-close" id="finishCloseBtn" aria-label="Close">Ã—</button>
    </div>

    <div class="bq-modal-body">
      <p class="bq-modal-subtitle">Game finished. Final standings:</p>

      <div class="bq-table-wrap">
        <table class="bq-table">
          <thead>
            <tr>
              <th style="width:64px;">#</th>
              <th>Player</th>
              <th style="width:90px;">Tile</th>
              <th style="width:90px;">Coins</th>
              <th style="width:70px;">HP</th>
              <th style="width:120px;">Status</th>
            </tr>
          </thead>
          <tbody id="finishLeaderboardBody">
            <!-- injected by JS -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="bq-modal-footer">
      <a id="backToLobbyBtn" class="btn btn-primary" href="{% url 'game:game_detail' game.id %}">
        Back to lobby
      </a>
    </div>
  </div>
</div>

<!-- Draft modal -->
<div id="draftModal" class="qmodal is-hidden" aria-hidden="true">
  <div class="qmodal-backdrop"></div>
  <div class="qmodal-card" role="dialog" aria-modal="true" aria-labelledby="draftTitle">
    <div class="qmodal-header">
      <h3 id="draftTitle">Draft Mode</h3>
      <span id="draftSub" class="smodal-subtitle" style="margin-left:auto;"></span>
    </div>
    <div class="qmodal-body">
      <div id="draftChoices" class="qchoices"></div>
      <p id="draftFeedback" class="qfeedback"></p>
    </div>
  </div>
</div>

<!-- Question modal -->
<div id="questionModal" class="qmodal is-hidden" aria-hidden="true">
    <div class="qmodal-backdrop"></div>

    <div class="qmodal-card" role="dialog" aria-modal="true" aria-labelledby="qmodalTitle">
        <div class="qmodal-header">
            <h3 id="qmodalTitle">Question</h3>

            <button id="changeQuestionBtn"
                    class="qhead-btn"
                    type="button"
                    disabled
                    title="Change question">
                ðŸ”„ Change
            </button>
        </div>

        <div class="qmodal-body">
            <div id="question-timer" class="qtimer hidden">
                <div class="qtimer-bar" id="qtimer-bar"></div>
                <span class="qtimer-text" id="qtimer-text">5</span>
            </div>
            <p id="qPrompt" class="qprompt"></p>
                <div id="qChoices" class="qchoices"></div>
            <p id="qFeedback" class="qfeedback"></p>
        </div>
    </div>
</div>

<!-- Shop modal -->
<div id="shopModal" class="smodal is-hidden" aria-hidden="true">
  <div class="smodal-backdrop"></div>

  <div class="smodal-card" role="dialog" aria-modal="true" aria-labelledby="smodalTitle">
    <div class="smodal-header">
      <div>
        <h3 id="smodalTitle">Shop</h3>
        <div class="smodal-subtitle">Coins: <strong id="sCoins">0</strong></div>
      </div>
      <button id="shopCloseBtn" class="qhead-btn" type="button">âœ… End turn</button>
    </div>

    <div class="smodal-body">
      <div class="sgrid">
        <div class="scol">
          <h4 class="scol-title">Buy support cards</h4>
          <div id="shopOffers" class="soffers"></div>
        </div>

        <div class="scol">
          <h4 class="scol-title">Sell from your inventory</h4>
          <div id="shopSellList" class="soffers"></div>
          <div class="muted" style="margin-top:10px;">Selling removes the card permanently.</div>
        </div>
      </div>

      <div id="shopFeedback" class="qfeedback" style="margin-top:12px;"></div>
    </div>
  </div>
</div>

<!-- Gun modal -->
<div id="gunModal" class="gun-modal is-hidden" aria-hidden="true">
  <div class="gun-card" role="dialog" aria-modal="true" aria-labelledby="gunTitle">
    <div class="gun-head">
      <div class="gun-title" id="gunTitle">Gun Tile</div>
      <div class="gun-meta">
        <span class="gun-badge">2 DMG</span>
        <button type="button" class="gun-x" id="gunCloseBtn" aria-label="Close">âœ•</button>
      </div>
    </div>

    <div class="gun-sub">
      Choose an alive player to attack.
    </div>

    <div id="gunTargets" class="gun-target-grid"></div>

    <div class="gun-foot">
      <div id="gunFeedback" class="gun-feedback"></div>
      <button type="button" class="gun-cancel" id="gunCancelBtn">Cancel</button>
    </div>
  </div>
</div>


<!-- Duel modal (Prediction Duel) -->
<div id="duelModal" class="dmodal is-hidden" aria-hidden="true">
  <div class="dmodal-backdrop"></div>

  <div class="dmodal-card" role="dialog" aria-modal="true" aria-labelledby="dmodalTitle">
    <div class="dmodal-header">
      <div>
        <h3 id="dmodalTitle">Prediction Duel</h3>
        <div id="dSub" class="smodal-subtitle">Make your move</div>
      </div>
      <div id="dHeaderRight"></div>
    </div>

    <div class="dmodal-body">
      <div id="dBody"></div>
      <div id="dFeedback" class="qfeedback" style="margin-top:12px;"></div>
    </div>
  </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
    window.GAME_ID = {{ game.id|safe }};
    window.GAME_HOST_USER_ID = {{ game.host_id|default:"null"|safe }};
    window.GAME_MAX_PLAYERS = {{ game.max_players|safe }};
</script>
<script>
  window.BQ_LOBBY_URL = "{% url 'game:game_detail' game.id %}";
</script>
<script src="{% static 'js/game_board.js' %}"></script>
{% endblock %}
