{% extends "base.html" %}
{% load static %}

{% block title %}Profile - BlitzQuest{% endblock %}

{# === Stylesheets === #}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile_v3.css' %}">
{% endblock %}

{% block body_class %}profile-v3-body{% endblock %}
{% block main_class %}full-width{% endblock %}

{% block content %}
<div class="profile-v3-container">
    {# === Sidebar Navigation === #}
    <aside class="profile-v3-sidebar">
        {# User Info #}
        <div class="sidebar-user-info">
            <div class="profile-v3-avatar-circle">
                {% if user.profile.profile_picture %}
                <img src="{{ user.profile.profile_picture.url }}" alt="Profile" class="v3-avatar-img">
                {% else %}
                <svg class="v3-avatar-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                </svg>
                {% endif %}
            </div>
            <div class="user-meta">
                <h2 class="user-v3-name">{{ user.get_full_name|default:user.username }}</h2>
                <p class="user-v3-role">Account settings</p>
            </div>
        </div>

        {# Navigation Links #}
        <nav class="sidebar-v3-nav">
            <a href="{% url 'game:home' %}" class="v3-nav-btn btn-gradient">
                <span class="v3-btn-icon">üè†</span>
                Back to home
                <span class="v3-btn-arrow">‚Äπ</span>
            </a>
            <a href="{% url 'game:faq' %}" class="v3-nav-btn btn-ghost">
                <span class="v3-btn-icon">üß©</span>
                Faq
                <span class="v3-btn-arrow">‚Äπ</span>
            </a>
        </nav>
    </aside>

    {# === Main Content === #}
    <main class="profile-v3-main">
        <div class="profile-v3-card">
            <h1 class="v3-card-title">Profile</h1>

            <div class="v3-card-content">
                {# Left Column: Account Settings #}
                <div class="v3-settings-col">
                    <h3 class="v3-section-label">Add Incomes</h3>

                    <form method="post" enctype="multipart/form-data" class="v3-profile-form">
                        {% csrf_token %}

                        {# Profile Picture Upload #}
                        <div class="v3-upload-section">
                            <label for="id_profile_picture" class="v3-photo-circle">
                                <span class="v3-camera-icon">üì∑</span>
                                <input type="file" name="profile_picture" id="id_profile_picture" class="v3-file-input">
                            </label>
                            <span class="v3-upload-text">Upload Photo</span>
                        </div>

                        {# Username Field #}
                        <div class="v3-form-group">
                            <label>Username</label>
                            <input type="text" name="username" value="{{ user.username }}" placeholder="Username"
                                class="editable-field" disabled>
                        </div>

                        {# Email Field #}
                        <div class="v3-form-group">
                            <label>Email</label>
                            <input type="email" name="email" value="{{ user.email }}" placeholder="Email"
                                class="editable-field" disabled>
                        </div>

                        {# Joined Date (Read-only) #}
                        <div class="v3-form-group">
                            <label>Joined On</label>
                            <div class="date-input-wrapper">
                                <input type="text" value="{{ user.date_joined|date:'d.m.Y' }}" readonly>
                                <span class="calendar-icon">üìÖ</span>
                            </div>
                        </div>

                        {# Action Buttons #}
                        <div class="v3-form-actions">
                            <button type="button" class="v3-btn-ghost" id="changeInfoBtn">Change info</button>
                            <button type="submit" class="v3-btn-primary" id="saveInfoBtn" disabled>Save info</button>
                        </div>
                    </form>
                </div>

                {# Right Column: Game History #}
                <div class="v3-history-col">
                    <h3 class="v3-section-label">History</h3>

                    <div class="v3-history-list">
                        {% for item in history %}
                        <div class="v3-history-item">
                            <div class="v3-history-info">
                                <p class="v3-history-title">{{ item.game.get_mode_display }}</p>
                                <div class="v3-history-meta">
                                    <span class="v3-meta-id"><span class="v3-icon">üîë</span> {{ item.game.code }}</span>
                                    <span class="v3-meta-date"><span class="v3-icon">üìÖ</span> {{
                                        item.created_at|date:"d F Y | h:i A" }}</span>
                                </div>
                            </div>
                            <div class="v3-history-time">
                                <span class="v3-clock-icon">üïí</span>
                                {{ item.duration }}
                            </div>
                        </div>
                        {% empty %}
                        <div class="v3-empty-history">No games played yet.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

{# === Profile Scripts === #}
<script>
    /**
     * Preview uploaded profile picture before form submission
     */
    document.getElementById('id_profile_picture').onchange = function (evt) {
        const [file] = this.files;
        if (file) {
            const preview = document.querySelector('.v3-avatar-img') || document.createElement('img');
            preview.src = URL.createObjectURL(file);
            preview.classList.add('v3-avatar-img');
            if (!document.querySelector('.v3-avatar-img')) {
                document.querySelector('.profile-v3-avatar-circle').innerHTML = '';
                document.querySelector('.profile-v3-avatar-circle').appendChild(preview);
            }
        }
    }

    /**
     * Enable/disable form fields for editing
     */
    const changeInfoBtn = document.getElementById('changeInfoBtn');
    const saveInfoBtn = document.getElementById('saveInfoBtn');
    const editableFields = document.querySelectorAll('.editable-field');
    const profileForm = document.querySelector('.v3-profile-form');

    changeInfoBtn.addEventListener('click', function () {
        // Enable all editable fields
        editableFields.forEach(field => {
            field.disabled = false;
        });

        // Enable the Save Info button
        saveInfoBtn.disabled = false;

        // Visual feedback
        changeInfoBtn.style.opacity = '0.6';
    });

    // Form submission feedback
    profileForm.addEventListener('submit', function (e) {
        saveInfoBtn.textContent = 'Saving...';
    });
</script>
{% endblock %}