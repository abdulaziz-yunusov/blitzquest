{% extends "base.html" %}
{% load static %}

{% block title %}Create game â€“ BlitzQuest{% endblock %}

{# === Stylesheets === #}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/game_create.css' %}">
{% endblock %}

{% block content %}
<div class="gc-page">
  {# === Main Creation Form === #}
  <section class="gc-card gc-card-main">
    <h2 class="gc-title">Create a new game</h2>
    <p class="gc-subtitle">
      Select your preferred game mode and customize the settings.
      Share the generated lobby code with friends to start your BlitzQuest adventure!
    </p>

    <form method="post" class="gc-form" id="gc-create-form">
      {% csrf_token %}

      {# Form Fields (excluding enabled_tiles) #}
      {% for field in form %}
      {% if field.name != 'enabled_tiles' %}
      <div class="gc-field" data-field-name="{{ field.name }}">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% if field.help_text %}
        <div class="gc-help">{{ field.help_text }}</div>
        {% endif %}
        {% for error in field.errors %}
        <div class="gc-error">{{ error }}</div>
        {% endfor %}
      </div>
      {% endif %}
      {% endfor %}

      {# Non-field Errors #}
      {% if form.non_field_errors %}
      <div class="gc-error-block">
        {% for error in form.non_field_errors %}
        {{ error }}<br>
        {% endfor %}
      </div>
      {% endif %}

      {# Finish Line Mode: Board Summary #}
      <div id="tiles-summary" class="gc-field" style="display:none;">
        <label>Board summary</label>
        <div class="gc-help" style="margin-top:6px;">
          <div><strong>Generated tiles:</strong> <span id="tile-count"></span></div>
          <div style="margin-top:4px;"><strong>Included tile types:</strong> <span id="tile-types"></span>
          </div>
        </div>
      </div>

      {# Finish Line Mode: Enabled Tiles Checkboxes #}
      <div class="form-group" id="enabled-tiles-block">
        <label>{{ form.enabled_tiles.label }}</label>
        <div class="checkbox-grid">
          {{ form.enabled_tiles }}
        </div>
        {% if form.enabled_tiles.errors %}
        <div class="form-error">{{ form.enabled_tiles.errors }}</div>
        {% endif %}
      </div>

      {# Action Buttons #}
      <div class="gc-actions" id="gc-actions">
        <button type="submit" class="btn btn-primary">Create game</button>
        <a href="{% url 'game:game_list' %}" class="gc-secondary-link">
          Cancel and go back
        </a>
      </div>
    </form>
  </section>

  {# === Help Sidebar === #}
  <section class="gc-card gc-card-side">
    <h3 class="gc-side-title">Game Modes</h3>
    <ul class="gc-side-list">
      <li><strong>Custom Game</strong>: Race to the finish line! First player to reach the final tile wins. Customize
        board length (20-80 tiles) and player count (2-4).</li>
      <li><strong>Survival</strong>: Battle for survival on a looping 35-tile board. Last player standing wins. Choose
        difficulty: Easy, Normal, or Hard.</li>
      <li><strong>Draft Mode</strong>: Strategic card selection! Draft 3 support cards before the game begins, then race
        to the finish.</li>
      <li><strong>Card Duel</strong>: Pure strategy! Build your deck, play attack and bonus cards, and eliminate
        opponents in turn-based combat.</li>
    </ul>
    <p class="gc-side-note">
      Each mode features unique mechanics, tile effects, and strategic depth. Roll dice, answer questions, use support
      cards, and outsmart your opponents!
    </p>
  </section>
</div>

{# === Form Logic Script === #}
<script>
  (function () {
    /**
     * Dynamic form field visibility based on selected game mode
     * - Custom Game: shows board_length, max_players, enabled_tiles
     * - Survival: shows only survival_difficulty
     * - Other modes: hide mode-specific fields
     */
    const modeSel = document.getElementById("id_mode");

    // Field wrappers
    const diffField = document.querySelector('.gc-field[data-field-name="survival_difficulty"]');
    const maxPlayersField = document.querySelector('.gc-field[data-field-name="max_players"]');
    const boardLenField = document.querySelector('.gc-field[data-field-name="board_length"]');

    const enabledTilesBlock = document.getElementById("enabled-tiles-block");
    const tilesSummary = document.getElementById("tiles-summary");

    const tileCountEl = document.getElementById("tile-count");
    const tileTypesEl = document.getElementById("tile-types");

    const boardLenInput = document.getElementById("id_board_length");
    const maxPlayersInput = document.getElementById("id_max_players");

    function getEnabledTileCheckboxes() {
      return Array.from(document.querySelectorAll('input[name="enabled_tiles"]'));
    }

    /**
     * Updates the board summary display for Custom Game mode
     */
    function updateTilesSummary() {
      const total = parseInt((boardLenInput && boardLenInput.value) || "36", 10);
      const safeTotal = Number.isFinite(total) ? total : 36;

      // Start + Finish are fixed
      const generated = Math.max(0, safeTotal - 2);

      if (tileCountEl) {
        tileCountEl.textContent = `${safeTotal} total (Start + Finish fixed, ${generated} generated)`;
      }

      if (!tileTypesEl) return;

      const boxes = getEnabledTileCheckboxes();
      const checked = boxes.filter(b => b.checked);

      if (checked.length === 0) {
        tileTypesEl.textContent = "ALL (default pool)";
        return;
      }

      const types = checked.map(cb => {
        const label = cb.closest("label");
        return label ? label.textContent.trim() : cb.value;
      });

      tileTypesEl.textContent = types.join(", ");
    }

    /**
     * Shows/hides form fields based on selected game mode
     */
    function syncModeUI() {
      const mode = modeSel ? modeSel.value : "finish";
      const isFinish = (mode === "finish");
      const isSurvival = (mode === "survival");

      // Show/hide mode-specific fields
      if (diffField) diffField.style.display = isSurvival ? "" : "none";
      if (boardLenField) boardLenField.style.display = isFinish ? "" : "none";
      if (maxPlayersField) maxPlayersField.style.display = isFinish ? "" : "none";

      if (enabledTilesBlock) enabledTilesBlock.style.display = isFinish ? "" : "none";
      if (tilesSummary) tilesSummary.style.display = isFinish ? "" : "none";

      // Enforce max_players constraints for Custom mode (2-4 players)
      if (maxPlayersInput && isFinish) {
        maxPlayersInput.setAttribute("min", "2");
        maxPlayersInput.setAttribute("max", "4");
        const currentValue = parseInt(maxPlayersInput.value) || 4;
        if (currentValue > 4) {
          maxPlayersInput.value = "4";
        } else if (currentValue < 2) {
          maxPlayersInput.value = "2";
        }
      }

      if (isFinish) updateTilesSummary();
    }

    // Event listeners
    if (modeSel) {
      modeSel.addEventListener("change", syncModeUI);
    }

    getEnabledTileCheckboxes().forEach(cb => {
      cb.addEventListener("change", updateTilesSummary);
    });

    if (boardLenInput) {
      boardLenInput.addEventListener("input", updateTilesSummary);
      boardLenInput.addEventListener("change", updateTilesSummary);
    }

    // Initialize
    syncModeUI();
    updateTilesSummary();
  })();
</script>

{% endblock %}