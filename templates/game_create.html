{% extends "base.html" %}
{% load static %}

{% block title %}Create game – BlitzQuest{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/game_create.css' %}">
{% endblock %}

{% block content %}
<div class="gc-page">
  <section class="gc-card gc-card-main">
    <h2 class="gc-title">Create a new game</h2>
    <p class="gc-subtitle">
      Choose a mode, board length, and maximum number of players.
      You’ll receive a lobby code to share with your friends.
    </p>

    <form method="post" class="gc-form" id="gc-create-form">
      {% csrf_token %}

      {% for field in form %}
      {% if field.name != 'enabled_tiles' %}
      <div class="gc-field" data-field-name="{{ field.name }}">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {{ field }}
        {% if field.help_text %}
        <div class="gc-help">{{ field.help_text }}</div>
        {% endif %}
        {% for error in field.errors %}
        <div class="gc-error">{{ error }}</div>
        {% endfor %}
      </div>
      {% endif %}
      {% endfor %}

      {% if form.non_field_errors %}
      <div class="gc-error-block">
        {% for error in form.non_field_errors %}
        {{ error }}<br>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Finish-line only summary -->
      <div id="tiles-summary" class="gc-field" style="display:none;">
        <label>Board summary</label>
        <div class="gc-help" style="margin-top:6px;">
          <div><strong>Generated tiles:</strong> <span id="tile-count"></span></div>
          <div style="margin-top:4px;"><strong>Included tile types:</strong> <span id="tile-types"></span>
          </div>
        </div>
      </div>

      <!-- Enabled tiles (Finish-line only) -->
      <div class="form-group" id="enabled-tiles-block">
        <label>{{ form.enabled_tiles.label }}</label>
        <div class="checkbox-grid">
          {{ form.enabled_tiles }}
        </div>
        {% if form.enabled_tiles.errors %}
        <div class="form-error">{{ form.enabled_tiles.errors }}</div>
        {% endif %}
      </div>

      <div class="gc-actions" id="gc-actions">
        <button type="submit" class="btn btn-primary">Create game</button>
        <a href="{% url 'game:game_list' %}" class="gc-secondary-link">
          Cancel and go back
        </a>
      </div>
    </form>
  </section>

  <section class="gc-card gc-card-side">
    <h3 class="gc-side-title">Quick rules</h3>
    <ul class="gc-side-list">
      <li>Supports <strong>2–4 players</strong>.</li>
      <li>Players start with <strong>3 HP</strong>, <strong>0 coins</strong>, and a random support card.</li>
      <li>On your turn, you <strong>roll the dice</strong>, move, and trigger the tile effect.</li>
      <li>Question tiles give you a kanji/quiz question; correct answers reward coins or bonuses.</li>
      <li>Traps, warps, and duels can change positions, reduce HP, or target other players.</li>
      <li>
        <strong>Finish mode</strong>: first to reach the final tile wins.
        <strong>Survival mode</strong>: last player standing wins.
      </li>
    </ul>
    <p class="gc-side-note">
      You can adjust the exact rules and tile layout later in development.
    </p>
  </section>
</div>

<script>
  (function () {
    const modeSel = document.getElementById("id_mode");

    // Field wrappers created by the loop above
    const diffField = document.querySelector('.gc-field[data-field-name="survival_difficulty"]');
    const maxPlayersField = document.querySelector('.gc-field[data-field-name="max_players"]');
    const boardLenField = document.querySelector('.gc-field[data-field-name="board_length"]');

    const enabledTilesBlock = document.getElementById("enabled-tiles-block");
    const tilesSummary = document.getElementById("tiles-summary");

    const tileCountEl = document.getElementById("tile-count");
    const tileTypesEl = document.getElementById("tile-types");

    const boardLenInput = document.getElementById("id_board_length");

    function getEnabledTileCheckboxes() {
      return Array.from(document.querySelectorAll('input[name="enabled_tiles"]'));
    }

    function updateTilesSummary() {
      // Finish Line can be variable length now
      const total = parseInt((boardLenInput && boardLenInput.value) || "36", 10);
      const safeTotal = Number.isFinite(total) ? total : 36;

      // Start + Finish are fixed in Finish Line
      const generated = Math.max(0, safeTotal - 2);

      if (tileCountEl) {
        tileCountEl.textContent = `${safeTotal} total (Start + Finish fixed, ${generated} generated)`;
      }

      if (!tileTypesEl) return;

      const boxes = getEnabledTileCheckboxes();
      const checked = boxes.filter(b => b.checked);

      if (checked.length === 0) {
        tileTypesEl.textContent = "ALL (default pool)";
        return;
      }

      const types = checked.map(cb => {
        const label = cb.closest("label");
        return label ? label.textContent.trim() : cb.value;
      });

      tileTypesEl.textContent = types.join(", ");
    }

    function syncModeUI() {
      const mode = modeSel ? modeSel.value : "finish";
      const isFinish = (mode === "finish");
      const isSurvival = (mode === "survival");

      // ✅ Your new requirement:
      // Finish Line: show board_length + max_players + enabled tiles + summary
      // Survival: show mode + survival_difficulty ONLY
      if (diffField) diffField.style.display = isSurvival ? "" : "none";
      if (boardLenField) boardLenField.style.display = isFinish ? "" : "none";
      if (maxPlayersField) maxPlayersField.style.display = isFinish ? "" : "none";

      if (enabledTilesBlock) enabledTilesBlock.style.display = isFinish ? "" : "none";
      if (tilesSummary) tilesSummary.style.display = isFinish ? "" : "none";

      if (isFinish) updateTilesSummary();
    }

    if (modeSel) {
      modeSel.addEventListener("change", syncModeUI);
    }

    // Update summary if tiles selection changes
    getEnabledTileCheckboxes().forEach(cb => {
      cb.addEventListener("change", updateTilesSummary);
    });

    // Update summary if board length changes
    if (boardLenInput) {
      boardLenInput.addEventListener("input", updateTilesSummary);
      boardLenInput.addEventListener("change", updateTilesSummary);
    }

    // Init
    syncModeUI();
    updateTilesSummary();
  })();
</script>

{% endblock %}